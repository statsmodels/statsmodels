from __future__ import print_function

# Copyright (c) 2013, Roger Lew [see LICENSE.txt]

from StringIO import StringIO

import unittest
import pandas
import numpy as np

from statsmodels.sandbox.stats import factorial_anova as anova


data_tbl = StringIO("""\
SUBJECT,SEX,AGE,GROUP,CYCLE,PHASE,SUPPRESSION,RANDDATA
1,1,23,AB,1,I,1,45
2,1,19,AB,1,I,21,44
3,1,19,AB,1,I,15,6
4,1,23,AB,1,I,30,36
5,0,21,AB,1,I,11,37
6,0,23,AB,1,I,16,34
7,1,19,AB,1,I,7,43
8,1,23,AB,1,I,0,11
1,0,20,AB,1,II,28,43
2,0,24,AB,1,II,21,45
3,0,20,AB,1,II,17,33
4,0,22,AB,1,II,34,42
5,1,19,AB,1,II,23,25
6,1,18,AB,1,II,11,14
7,1,20,AB,1,II,26,43
8,0,18,AB,1,II,22,27
1,1,19,AB,2,I,22,41
2,1,21,AB,2,I,16,25
3,0,23,AB,2,I,13,43
4,0,19,AB,2,I,55,6
5,1,23,AB,2,I,12,40
6,0,20,AB,2,I,18,23
7,0,23,AB,2,I,29,20
8,0,20,AB,2,I,23,7
1,1,24,AB,2,II,48,38
2,1,20,AB,2,II,40,13
3,0,21,AB,2,II,35,9
4,0,18,AB,2,II,54,49
5,1,21,AB,2,II,33,41
6,1,21,AB,2,II,34,41
7,1,20,AB,2,II,40,25
8,0,19,AB,2,II,45,39
1,1,20,AB,3,I,22,12
2,0,19,AB,3,I,15,4
3,0,18,AB,3,I,22,6
4,1,20,AB,3,I,37,31
5,0,20,AB,3,I,10,46
6,1,18,AB,3,I,11,1
7,1,24,AB,3,I,25,44
8,0,25,AB,3,I,18,25
1,1,25,AB,3,II,50,39
2,1,24,AB,3,II,39,26
3,1,20,AB,3,II,45,14
4,1,25,AB,3,II,57,40
5,1,18,AB,3,II,50,28
6,0,20,AB,3,II,40,13
7,0,19,AB,3,II,50,11
8,1,20,AB,3,II,38,31
1,1,23,AB,4,I,14,43
2,0,18,AB,4,I,11,34
3,1,24,AB,4,I,1,7
4,0,21,AB,4,I,57,19
5,1,18,AB,4,I,8,33
6,1,24,AB,4,I,5,24
7,1,25,AB,4,I,14,19
8,0,20,AB,4,I,15,35
1,0,18,AB,4,II,48,35
2,1,22,AB,4,II,56,12
3,1,22,AB,4,II,43,17
4,0,20,AB,4,II,68,26
5,1,25,AB,4,II,53,30
6,1,25,AB,4,II,40,45
7,1,18,AB,4,II,56,6
8,1,24,AB,4,II,50,0
9,1,23,AA,1,I,1,12
10,0,21,AA,1,I,37,40
11,0,18,AA,1,I,18,2
12,0,18,AA,1,I,1,2
13,0,18,AA,1,I,44,30
14,0,19,AA,1,I,15,36
15,0,22,AA,1,I,0,3
16,1,22,AA,1,I,26,22
9,0,22,AA,1,II,6,6
10,0,25,AA,1,II,59,36
11,0,25,AA,1,II,43,22
12,0,20,AA,1,II,2,29
13,1,19,AA,1,II,25,5
14,1,20,AA,1,II,14,48
15,1,18,AA,1,II,3,19
16,1,20,AA,1,II,15,41
9,1,20,AA,2,I,16,26
10,0,18,AA,2,I,28,16
11,0,24,AA,2,I,38,45
12,1,23,AA,2,I,9,34
13,0,25,AA,2,I,28,38
14,0,18,AA,2,I,22,22
15,1,25,AA,2,I,7,1
16,1,20,AA,2,I,31,9
9,1,24,AA,2,II,8,4
10,1,25,AA,2,II,36,9
11,0,24,AA,2,II,50,22
12,1,22,AA,2,II,8,21
13,1,23,AA,2,II,42,40
14,1,18,AA,2,II,32,10
15,0,18,AA,2,II,17,13
16,0,19,AA,2,II,32,19
9,0,21,AA,3,I,9,3
10,0,21,AA,3,I,34,14
11,0,20,AA,3,I,39,16
12,0,22,AA,3,I,6,2
13,0,23,AA,3,I,47,27
14,1,23,AA,3,I,16,26
15,0,25,AA,3,I,6,2
16,1,23,AA,3,I,28,2
9,1,18,AA,3,II,14,37
10,1,25,AA,3,II,32,5
11,0,20,AA,3,II,15,4
12,1,18,AA,3,II,5,8
13,0,22,AA,3,II,46,45
14,1,20,AA,3,II,23,37
15,1,20,AA,3,II,9,48
16,0,18,AA,3,II,22,20
9,1,22,AA,4,I,11,45
10,0,23,AA,4,I,26,47
11,1,22,AA,4,I,29,11
12,0,25,AA,4,I,5,25
13,0,22,AA,4,I,33,21
14,0,23,AA,4,I,32,43
15,1,20,AA,4,I,10,28
16,0,22,AA,4,I,16,41
9,0,23,AA,4,II,33,21
10,0,23,AA,4,II,37,37
11,0,21,AA,4,II,18,15
12,1,24,AA,4,II,15,40
13,1,19,AA,4,II,35,23
14,1,18,AA,4,II,26,40
15,0,19,AA,4,II,15,35
16,0,24,AA,4,II,15,19
17,0,23,LAB,1,I,33,21
18,1,20,LAB,1,I,4,46
19,1,19,LAB,1,I,32,11
20,0,20,LAB,1,I,17,41
21,1,25,LAB,1,I,44,23
22,1,18,LAB,1,I,12,25
23,1,18,LAB,1,I,18,9
24,0,25,LAB,1,I,13,1
17,1,23,LAB,1,II,43,50
18,0,22,LAB,1,II,35,2
19,0,23,LAB,1,II,39,46
20,1,20,LAB,1,II,34,11
21,1,18,LAB,1,II,52,41
22,1,23,LAB,1,II,16,42
23,0,25,LAB,1,II,42,19
24,0,23,LAB,1,II,29,30
17,1,22,LAB,2,I,40,2
18,0,20,LAB,2,I,9,12
19,1,19,LAB,2,I,38,0
20,1,24,LAB,2,I,21,12
21,1,21,LAB,2,I,37,21
22,0,24,LAB,2,I,9,22
23,1,18,LAB,2,I,3,1
24,0,20,LAB,2,I,14,43
17,1,24,LAB,2,II,52,33
18,0,24,LAB,2,II,42,49
19,1,23,LAB,2,II,47,16
20,1,19,LAB,2,II,41,20
21,1,24,LAB,2,II,48,39
22,1,18,LAB,2,II,39,50
23,0,25,LAB,2,II,62,8
24,0,19,LAB,2,II,44,18
17,0,23,LAB,3,I,39,18
18,1,21,LAB,3,I,4,1
19,0,22,LAB,3,I,24,16
20,0,25,LAB,3,I,27,15
21,0,25,LAB,3,I,33,17
22,0,23,LAB,3,I,9,27
23,1,19,LAB,3,I,45,21
24,0,24,LAB,3,I,9,6
17,1,21,LAB,3,II,52,27
18,1,23,LAB,3,II,46,49
19,0,25,LAB,3,II,44,32
20,0,24,LAB,3,II,50,5
21,1,22,LAB,3,II,53,44
22,0,25,LAB,3,II,59,30
23,1,20,LAB,3,II,49,26
24,0,24,LAB,3,II,50,7
17,1,20,LAB,4,I,38,24
18,1,23,LAB,4,I,23,37
19,1,25,LAB,4,I,16,42
20,1,22,LAB,4,I,13,8
21,1,21,LAB,4,I,33,31
22,1,19,LAB,4,I,13,39
23,0,25,LAB,4,I,60,36
24,0,22,LAB,4,I,15,42
17,0,25,LAB,4,II,48,30
18,0,23,LAB,4,II,51,34
19,1,18,LAB,4,II,40,14
20,1,24,LAB,4,II,40,20
21,1,22,LAB,4,II,43,21
22,0,20,LAB,4,II,45,37
23,0,24,LAB,4,II,57,26
24,0,22,LAB,4,II,48,46""")

class Test_anova_mixed(unittest.TestCase):
    def test3(self):
        ## Mixed Between/Within test

        R = """\
SUPPRESSION ~ CYCLE * PHASE * GROUP

TESTS OF BETWEEN-SUBJECTS EFFECTS

Measure: SUPPRESSION
     Source        Type III   df    MS       F     Sig.    et2_G   Obs.    SE     95% CI   lambda   Obs.  
                      SS                                                                            Power 
=========================================================================================================
Between Subjects      2.034   23                                                                          
GROUP                 0.462    2   0.231   3.083   0.067   0.150      8   0.103    0.201    2.349   0.229 
=========================================================================================================
Error                 1.572   21   0.075                                                                  

TESTS OF WITHIN SUBJECTS EFFECTS

Measure: SUPPRESSION
       Source                                Type III    eps      df      MS        F        Sig.      et2_G   Obs.    SE     95% CI   lambda    Obs.  
                                                SS                                                                                               Power 
======================================================================================================================================================
CYCLE                   Sphericity Assumed      0.273       -        3   0.091    12.027   2.535e-06   0.094     48   0.013    0.025    27.491   0.995 
                        Greenhouse-Geisser      0.273   0.668    2.005   0.136    12.027   7.281e-05   0.094     48   0.013    0.025    27.491   0.967 
                        Huynh-Feldt             0.273   0.668    2.005   0.136    12.027   7.281e-05   0.094     48   0.013    0.025    27.491   0.967 
                        Box                     0.273   0.333        1   0.273    12.027       0.002   0.094     48   0.013    0.025    27.491   0.823 
------------------------------------------------------------------------------------------------------------------------------------------------------
CYCLE * GROUP           Sphericity Assumed      0.105       -        6   0.017     2.309       0.044   0.038     16   0.022    0.043     3.519   0.218 
                        Greenhouse-Geisser      0.105   0.572    3.434   0.030     2.309       0.085   0.038     16   0.022    0.043     3.519   0.167 
                        Huynh-Feldt             0.105   0.572    3.434   0.030     2.309       0.085   0.038     16   0.022    0.043     3.519   0.167 
                        Box                     0.105   0.167        1   0.105     2.309       0.158   0.038     16   0.022    0.043     3.519   0.107 
------------------------------------------------------------------------------------------------------------------------------------------------------
Error(CYCLE)            Sphericity Assumed      0.476       -       63   0.008                                                                         
                        Greenhouse-Geisser      0.476   0.572   36.061   0.013                                                                         
                        Huynh-Feldt             0.476   0.572   36.061   0.013                                                                         
                        Box                     0.476   0.167   10.500   0.045                                                                         
------------------------------------------------------------------------------------------------------------------------------------------------------
PHASE                   Sphericity Assumed      1.170       -        1   1.170   129.855   1.878e-10   0.308     96   0.010    0.020   593.625       1 
                        Greenhouse-Geisser      1.170       1        1   1.170   129.855   1.878e-10   0.308     96   0.010    0.020   593.625       1 
                        Huynh-Feldt             1.170       1        1   1.170   129.855   1.878e-10   0.308     96   0.010    0.020   593.625       1 
                        Box                     1.170       1        1   1.170   129.855   1.878e-10   0.308     96   0.010    0.020   593.625       1 
------------------------------------------------------------------------------------------------------------------------------------------------------
PHASE * GROUP           Sphericity Assumed      0.405       -        2   0.203    22.493   6.012e-06   0.134     32   0.018    0.035    68.551   1.000 
                        Greenhouse-Geisser      0.405   0.820    1.641   0.247    22.493   3.263e-05   0.134     32   0.018    0.035    68.551   1.000 
                        Huynh-Feldt             0.405   0.820    1.641   0.247    22.493   3.263e-05   0.134     32   0.018    0.035    68.551   1.000 
                        Box                     0.405   0.500        1   0.405    22.493   6.896e-04   0.134     32   0.018    0.035    68.551   1.000 
------------------------------------------------------------------------------------------------------------------------------------------------------
Error(PHASE)            Sphericity Assumed      0.189       -       21   0.009                                                                         
                        Greenhouse-Geisser      0.189   0.820   17.228   0.011                                                                         
                        Huynh-Feldt             0.189   0.820   17.228   0.011                                                                         
                        Box                     0.189   0.500   10.500   0.018                                                                         
------------------------------------------------------------------------------------------------------------------------------------------------------
CYCLE *                 Sphericity Assumed      0.074       -        3   0.025     4.035       0.011   0.027     24   0.016    0.032     4.612   0.386 
PHASE                   Greenhouse-Geisser      0.074   0.686    2.057   0.036     4.035       0.024   0.027     24   0.016    0.032     4.612   0.313 
                        Huynh-Feldt             0.074   0.686    2.057   0.036     4.035       0.024   0.027     24   0.016    0.032     4.612   0.313 
                        Box                     0.074   0.333        1   0.074     4.035       0.058   0.027     24   0.016    0.032     4.612   0.220 
------------------------------------------------------------------------------------------------------------------------------------------------------
CYCLE * PHASE * GROUP   Sphericity Assumed      0.127       -        6   0.021     3.466       0.005   0.046      8   0.028    0.055     2.641   0.169 
                        Greenhouse-Geisser      0.127   0.605    3.629   0.035     3.466       0.019   0.046      8   0.028    0.055     2.641   0.137 
                        Huynh-Feldt             0.127       1        6   0.021     3.466       0.005   0.046      8   0.028    0.055     2.641   0.169 
                        Box                     0.127   0.167        1   0.127     3.466       0.091   0.046      8   0.028    0.055     2.641   0.093 
------------------------------------------------------------------------------------------------------------------------------------------------------
Error(CYCLE *           Sphericity Assumed      0.386       -       63   0.006                                                                         
PHASE)                  Greenhouse-Geisser      0.386   0.605   38.105   0.010                                                                         
                        Huynh-Feldt             0.386       1       63   0.006                                                                         
                        Box                     0.386   0.167   10.500   0.037                                                                         

TABLES OF ESTIMATED MARGINAL MEANS

Estimated Marginal Means for CYCLE
CYCLE   Mean    Std. Error   95% Lower Bound   95% Upper Bound 
==============================================================
1       0.220        0.041             0.139             0.301 
2       0.306        0.088             0.134             0.477 
3       0.307        0.139             0.035             0.579 
4       0.308        0.190            -0.064             0.680 

Estimated Marginal Means for PHASE
PHASE   Mean    Std. Error   95% Lower Bound   95% Upper Bound 
==============================================================
I       0.207        0.014             0.180             0.234 
II      0.363        0.016             0.332             0.394 

Estimated Marginal Means for GROUP
GROUP   Mean    Std. Error   95% Lower Bound   95% Upper Bound 
==============================================================
AA      0.222        0.018             0.187             0.256 
AB      0.292        0.022             0.250             0.334 
LAB     0.341        0.020             0.302             0.381 

Estimated Marginal Means for CYCLE * PHASE
CYCLE   PHASE   Mean    Std. Error   95% Lower Bound   95% Upper Bound 
======================================================================
1       I       0.173        0.028             0.119             0.228 
1       II      0.266        0.031             0.206             0.326 
2       I       0.224        0.026             0.173             0.275 
2       II      0.387        0.027             0.335             0.439 
3       I       0.223        0.027             0.170             0.276 
3       II      0.391        0.032             0.327             0.454 
4       I       0.207        0.031             0.146             0.269 
4       II      0.408        0.030             0.350             0.466 

Estimated Marginal Means for CYCLE * GROUP
CYCLE   GROUP   Mean    Std. Error   95% Lower Bound   95% Upper Bound 
======================================================================
1       AA      0.193        0.046             0.104             0.282 
1       AB      0.177        0.025             0.128             0.225 
1       LAB     0.289        0.035             0.221             0.358 
2       AA      0.253        0.033             0.187             0.318 
2       AB      0.323        0.035             0.254             0.392 
2       LAB     0.341        0.044             0.256             0.427 
3       AA      0.219        0.036             0.149             0.289 
3       AB      0.331        0.039             0.255             0.406 
3       LAB     0.371        0.044             0.285             0.456 
4       AA      0.223        0.026             0.172             0.273 
4       AB      0.337        0.057             0.225             0.449 
4       LAB     0.364        0.040             0.287             0.442 

Estimated Marginal Means for PHASE * GROUP
PHASE   GROUP   Mean    Std. Error   95% Lower Bound   95% Upper Bound 
======================================================================
I       AA      0.209        0.024             0.162             0.255 
I       AB      0.179        0.023             0.134             0.225 
I       LAB     0.233        0.026             0.183             0.283 
II      AA      0.235        0.026             0.184             0.286 
II      AB      0.404        0.023             0.359             0.450 
II      LAB     0.450        0.016             0.419             0.481 

Estimated Marginal Means for CYCLE * PHASE * GROUP
CYCLE   PHASE   GROUP   Mean    Std. Error   95% Lower Bound   95% Upper Bound 
==============================================================================
1       I       AA      0.177        0.060             0.060             0.295 
1       I       AB      0.126        0.036             0.056             0.196 
1       I       LAB     0.216        0.047             0.124             0.309 
1       II      AA      0.209        0.072             0.067             0.351 
1       II      AB      0.228        0.025             0.179             0.276 
1       II      LAB     0.363        0.038             0.288             0.437 
2       I       AA      0.224        0.039             0.148             0.300 
2       I       AB      0.235        0.049             0.139             0.331 
2       I       LAB     0.214        0.053             0.110             0.317 
2       II      AA      0.281        0.055             0.173             0.389 
2       II      AB      0.411        0.026             0.360             0.463 
2       II      LAB     0.469        0.026             0.417             0.520 
3       I       AA      0.231        0.057             0.120             0.342 
3       I       AB      0.200        0.031             0.140             0.260 
3       I       LAB     0.238        0.054             0.133             0.342 
3       II      AA      0.208        0.047             0.115             0.300 
3       II      AB      0.461        0.024             0.414             0.508 
3       II      LAB     0.504        0.016             0.472             0.535 
4       I       AA      0.203        0.039             0.126             0.279 
4       I       AB      0.156        0.062             0.036             0.277 
4       I       LAB     0.264        0.058             0.149             0.378 
4       II      AA      0.242        0.034             0.176             0.309 
4       II      AB      0.517        0.031             0.457             0.578 
4       II      LAB     0.465        0.020             0.425             0.505 

"""
        data_tbl.seek(0)
        df = pandas.io.parsers.read_csv(data_tbl)
        
		# don't recall why I'm doing this transformation
        df['SUPPRESSION'] *= .01

        aov_results = anova.anova(df, 'SUPPRESSION',
                                  wfactors=['CYCLE','PHASE'],
                                  bfactors=['GROUP'],
                                  sub='SUBJECT')                          
        D = aov_results.summary()
        print(D)
##        self.assertEqual(R,D)
            
def suite():
    return unittest.TestSuite((
            unittest.makeSuite(Test_anova_mixed)
                              ))

if __name__ == "__main__":
    # run tests
    runner = unittest.TextTestRunner()
    runner.run(suite())
    
